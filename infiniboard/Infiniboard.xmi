
/* Configuration {{{ */
#define IFIconList SBIconListView
#define IFBottomPadding 0
/* }}} */

#import <infinishared/Infinilist.h>
#import <infinishared/Preferences.h>

/* Infiniboard {{{ */
%group IFInfiniboard

static void IFRestoreIconLists() {
    IFPreferencesApply();

    for (UIScrollView *scrollView in scrollies) {
        if (IFPreferencesBoolForKey(@"RestoreEnabled", NO))
            [scrollView setContentOffset:CGPointZero animated:NO];

        if (IFPreferencesIntForKey(@"ScrollbarStyle", 0) != kIFScrollbarStyleNone)
            [scrollView flashScrollIndicators];
    }
}

%hook SBIconController

- (void)scrollViewDidEndDecelerating:(id)scrollView {
    if (IFPreferencesBoolForKey(@"FastRestoreEnabled", NO)) {
        for (UIScrollView *scrollView in scrollies) {
            [scrollView setContentOffset:CGPointZero animated:NO];
        }
    }

    %orig;
}

%end

%hook SBUIController

- (void)restoreIconList:(BOOL)unk {
    %orig;
    IFRestoreIconLists();
}
- (void)restoreIconListAnimated:(BOOL)animated {
    %orig;
    IFRestoreIconLists();
}
- (void)restoreIconListAnimated:(BOOL)animated animateWallpaper:(BOOL)animateWallpaper {
    %orig;
    IFRestoreIconLists();
}
- (void)restoreIconListAnimated:(BOOL)animated animateWallpaper:(BOOL)wallpaper keepSwitcher:(BOOL)switcher {
    %orig;
    IFRestoreIconLists();
}

%end

%end

/* }}} */
/* Constructor {{{ */

__attribute__((constructor)) static void infiniboard_init() {
    NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];

    if (![[[NSBundle mainBundle] bundleIdentifier] isEqualToString:@"com.apple.springboard"])
        return;

    NSLog(@"Welcome to Infiniboard.");

    IFPreferencesInitialize(@"com.chpwn.infiniboard");

    dlopen("/Library/MobileSubstrate/DynamicLibraries/IconSupport.dylib", RTLD_LAZY);
    [[objc_getClass("ISIconSupport") sharedInstance] addExtension:@"infiniboard"];

    scrollies = [[NSMutableArray alloc] init];
    listies = [[NSMutableArray alloc] init];

    %init(IFBasic);
    %init(IFInfiniboard);
    infinishared_init();

    [pool release];
}

/* }}} */

